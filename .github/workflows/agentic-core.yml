# .github/workflows/agentic-core.yml
name: Agentic Core
on:
  workflow_call:
    inputs:
      agent:        { required: true,  type: string }
      issue_number: { required: true,  type: string }
      files:        { required: false, type: string }
      branch:       { required: false, type: string, default: 'main' }
    secrets:
      ANTHROPIC_API_KEY: { required: false }  # 使う時だけ

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { ref: ${{ inputs.branch }} }

      # --- agent ごとの分岐（stub） ---
      - name: Issue analyze (stub)
        if: ${{ inputs.agent == 'issue' }}
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const n = parseInt("${{ inputs.issue_number }}", 10);
            await github.issues.addLabels({ owner, repo, issue_number: n, labels: ['ai:triaged'] });

      - name: Codegen (stub)
        if: ${{ inputs.agent == 'codegen' }}
        run: |
          set -e
          BRANCH="feat/issue-${{ inputs.issue_number }}-${GITHUB_RUN_ID}"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          echo "# Auto scaffold for issue #${{ inputs.issue_number }}" > ai_${{ inputs.issue_number }}.md
          git add . && git commit -m "feat: scaffold for issue #${{ inputs.issue_number }}" && git push -u origin "$BRANCH"

      - name: Open draft PR (stub)
        if: ${{ inputs.agent == 'codegen' }}
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            await github.pulls.create({
              owner, repo,
              head: `feat/issue-${{ inputs.issue_number }}-${process.env.GITHUB_RUN_ID}`,
              base: '${{ inputs.branch || 'main' }}',
              title: `feat: implement Issue #${{ inputs.issue_number }}`,
              body: 'Draft PR (stub)',
              draft: true
            })
