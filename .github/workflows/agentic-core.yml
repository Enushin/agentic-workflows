# .github/workflows/agentic-core.yml
name: Agentic Core
on:
  workflow_call:
    inputs:
      agent:        { required: true,  type: string }
      issue_number: { required: true,  type: string }
      files:        { required: false, type: string }
      branch:       { required: false, type: string, default: 'main' }
    secrets:
      ANTHROPIC_API_KEY: { required: false }

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Setup Node (shared)
        if: ${{ inputs.agent != 'issue' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      # â”€â”€ Issue Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Issue intake & labeling
        if: ${{ inputs.agent == 'issue' }}
        id: issue_labels
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = parseInt('${{ inputs.issue_number }}', 10);

            const issue = await github.issues.get({ owner, repo, issue_number: issueNumber });
            const body = issue.data.body || '';

            const sections = {};
            const regex = /^#\s+(.+?)\s*\n([\s\S]*?)(?=^#\s+|\Z)/gm;
            let match;
            while ((match = regex.exec(body)) !== null) {
              sections[match[1].trim()] = match[2].trim();
            }

            const priorityMatch = body.match(/â¡ï¸P[0-3]-[^\s]+/);
            const priorityLabel = priorityMatch ? priorityMatch[0] : 'â¡ï¸P2-ä¸­';
            const statusLabel = '00.æœªç€æ‰‹';

            const authorityMatch = body.match(/ğŸ”´|ğŸ”µ|ğŸŸ¡/);
            const authorityIcon = authorityMatch ? authorityMatch[0] : 'ğŸ”µ';

            await github.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: [statusLabel, priorityLabel]
            });

            const summary = [
              `TL;DR: ${(sections['TL;DRï¼ˆæ—¥æœ¬èªï¼‰'] || '').split('\n')[0]}`,
              `å„ªå…ˆåº¦: ${priorityLabel}`,
              `æ¨©é™ãƒ¬ãƒ™ãƒ«: ${authorityIcon}`,
            ].join('\n');

            await github.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                '## âœ… IssueAgent è‡ªå‹•å‡¦ç†çµæœ',
                '',
                summary,
                '',
                'ä¸è¶³é …ç›®ãŒã‚ã‚‹å ´åˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚'
              ].join('\n')
            });

      # â”€â”€ Coordinator Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Coordinator plan
        if: ${{ inputs.agent == 'coordinator' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = parseInt('${{ inputs.issue_number }}', 10);
            const dag = [
              '- PRD/ARCHæ•´å‚™',
              '- å®Ÿè£…ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆï¼‰',
              '- ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ä¿®æ­£',
              '- PRä½œæˆãƒ»QA',
            ].join('\n');

            await github.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['01.é€²è¡Œä¸­']
            });

            await github.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                '## ğŸ§­ CoordinatorAgent ãƒ—ãƒ©ãƒ³',
                '',
                dag,
                '',
                'â€» å¿…è¦ã«å¿œã˜ã¦ DAG ã‚’ç·¨é›†ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„ã€‚'
              ].join('\n')
            });

      # â”€â”€ CodeGen Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        if: ${{ inputs.agent == 'codegen' }}
        run: npm ci

      - name: Run code generation
        if: ${{ inputs.agent == 'codegen' }}
        run: npm run agentic:codegen -- --issue ${{ inputs.issue_number }}

      - name: Summarize codegen output
        if: ${{ inputs.agent == 'codegen' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = parseInt('${{ inputs.issue_number }}', 10);

            await github.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['02.ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­']
            });

            await github.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                '## ğŸ¤– CodeGenAgent å®Ÿè¡Œçµæœ',
                '',
                '- ç”Ÿæˆç‰©ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚',
                '- è¿½åŠ èª¿æ•´ãŒå¿…è¦ãªå ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã—ã¾ã™ã€‚',
              ].join('\n')
            });

      # â”€â”€ Review Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies (review)
        if: ${{ inputs.agent == 'review' }}
        run: npm ci

      - name: Run lint
        if: ${{ inputs.agent == 'review' }}
        id: lint
        continue-on-error: true
        run: npm run lint

      - name: Run tests
        if: ${{ inputs.agent == 'review' }}
        id: tests
        continue-on-error: true
        run: npm test -- --watch=false

      - name: Compute quality score
        if: ${{ inputs.agent == 'review' }}
        id: quality
        run: |
          lint_outcome="${{ steps.lint.outcome }}"
          test_outcome="${{ steps.tests.outcome }}"
          score=100
          if [ "$lint_outcome" != "success" ]; then score=$((score-50)); fi
          if [ "$test_outcome" != "success" ]; then score=$((score-50)); fi
          echo "score=$score" >> "$GITHUB_OUTPUT"

      - name: Post review result
        if: ${{ inputs.agent == 'review' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = parseInt('${{ inputs.issue_number }}', 10);
            const score = Number('${{ steps.quality.outputs.score }}');
            const lintOK = '${{ steps.lint.outcome }}' === 'success';
            const testOK = '${{ steps.tests.outcome }}' === 'success';

            const passed = score >= 80;
            const statusLabel = passed ? '04.ãƒ†ã‚¹ãƒˆä¸­' : '03.ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­';

            await github.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: [statusLabel]
            });

            const commentLines = [
              '## ğŸ›¡ ReviewAgent è©•ä¾¡',
              '',
              `quality_score: ${score}`,
              `Lint: ${lintOK ? 'PASS' : 'FAIL'}`,
              `Tests: ${testOK ? 'PASS' : 'FAIL'}`,
              ''
            ];

            if (passed) {
              commentLines.push('âœ… å—ã‘å…¥ã‚Œæ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸã€‚æ¬¡ã®å·¥ç¨‹ã¸é€²ã‚ã¦ãã ã•ã„ã€‚');
            } else {
              commentLines.push('âš ï¸ quality_score < 80 ã®ãŸã‚ `03.ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­` ã«æˆ»ã—ã¾ã—ãŸã€‚å¯¾å¿œå¾Œã«å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            }

            await github.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: commentLines.join('\n')
            });

            if (!passed) {
              core.setFailed('quality_score below threshold');
            }

      # â”€â”€ PR Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure dependencies
        if: ${{ inputs.agent == 'pr' }}
        run: npm ci

      - name: Create draft PR
        if: ${{ inputs.agent == 'pr' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = parseInt('${{ inputs.issue_number }}', 10);
            const branch = 'feat/issue-' + issueNumber;
            const title = `feat: close #${issueNumber}`;

            try {
              await github.pulls.create({
                owner,
                repo,
                head: branch,
                base: '${{ inputs.branch }}',
                title,
                body: 'Draft PR generated by PRAgent',
                draft: true
              });
            } catch (error) {
              if (error.status !== 422) throw error;
            }

            await github.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['04.ãƒ†ã‚¹ãƒˆä¸­']
            });

            await github.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                '## ğŸ“¦ PRAgent å®Ÿè¡Œçµæœ',
                '',
                `ãƒ‰ãƒ©ãƒ•ãƒˆPRã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆbranch: feat/issue-${issueNumber}ï¼‰ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚`
              ].join('\n')
            });

      # â”€â”€ KPI Collector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Trigger KPI collection
        if: ${{ inputs.agent == 'kpi' }}
        run: node scripts/collect-metrics.js --period=24h

      - name: Comment KPI update
        if: ${{ inputs.agent == 'kpi' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = parseInt('${{ inputs.issue_number }}', 10);
            await github.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: 'ğŸ“Š KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚'
            });
